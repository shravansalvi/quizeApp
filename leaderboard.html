<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Leaderboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/theme.css">
<link rel="stylesheet" href="./css/animation.css">

<style>
body {
  background:#020617;
  color:white;
  font-family:Inter, Arial;
  text-align:center;
  padding:20px;
}
table {
  margin:auto;
  border-collapse:collapse;
  width:90%;
  max-width:700px;
}
th, td {
  border:1px solid #22d3ee;
  padding:12px;
}
th {
  background:#020617;
}
tr {
  animation: fadeUp 0.4s ease;
}
@keyframes fadeUp {
  from {opacity:0; transform:translateY(8px);}
  to {opacity:1; transform:translateY(0);}
}
</style>
</head>

<body>
<div class="card fade-in">

<h2>üèÜ Leaderboard</h2>
<p id="msg"></p>

<table>
<thead>
<tr>
  <th>Name</th>
  <th>Score</th>
  <th>Date</th>
</tr>
</thead>
<tbody id="board"></tbody>
</table>

<script type="module">
/* ---------- IMPORTS ---------- */
import { ref, get } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

import { onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { auth, db } from "./assets/js/firebase.js";

/* ---------- ELEMENTS ---------- */
const board = document.getElementById("board");
const msg = document.getElementById("msg");

/* ---------- AUTH CHECK ---------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  try {
    const usersSnap = await get(ref(db, "users"));
    const resultsSnap = await get(ref(db, "results"));

    if (!resultsSnap.exists()) {
      msg.textContent = "No results found.";
      return;
    }

    const users = usersSnap.exists() ? usersSnap.val() : {};
    const results = resultsSnap.val();

    let rows = [];

    Object.entries(results).forEach(([uid, attempts]) => {
      Object.values(attempts).forEach(r => {
        rows.push({
          name: users[uid]?.name || "Unknown",
          score: r.score,
          total: r.total,
          time: r.time
        });
      });
    });

    // üîΩ Sort by score (DESC)
    rows.sort((a, b) => b.score - a.score);

    if (rows.length === 0) {
      msg.textContent = "No leaderboard data.";
      return;
    }

    rows.forEach(r => {
      board.innerHTML += `
        <tr>
          <td>${r.name}</td>
          <td>${r.score} / ${r.total}</td>
          <td>${new Date(r.time).toLocaleString()}</td>
        </tr>`;
    });

  } catch (err) {
    console.error(err);
    msg.textContent = "Error loading leaderboard.";
  }
});
</script>

</body>
</html>
